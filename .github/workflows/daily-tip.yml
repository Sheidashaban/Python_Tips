name: Daily Python Tip Generator

on:
  schedule:
    # Runs at 10:00 AM UTC daily (adjust for your timezone)
    # For EST: use 15:00, For PST: use 18:00, For CET: use 09:00
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allows manual testing

jobs:
  generate-and-send-tip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout agent repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
      
      - name: Clone Python_Tips repository
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/Sheidashaban/Python_Tips.git python_tips_repo
          cd python_tips_repo
          git config user.name "Python Tip Bot"
          git config user.email "python-tip-bot@github-actions.com"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate and send daily Python tip
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          GITHUB_REPO_URL: https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/Sheidashaban/Python_Tips.git
          GITHUB_BRANCH: master
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SMTP_SERVER: smtp.gmail.com
          SMTP_PORT: 587
          APPROVAL_BASE_URL: https://github.com/Sheidashaban/Python_Tips
          DAILY_RUN_TIME: "10:00"
        run: |
          echo "Starting daily Python tip generation..."
          python main_agent.py run
      
      - name: Push new tip to Python_Tips repository
        run: |
          # Copy generated tip to Python_Tips repo
          cp tips/*.ipynb python_tips_repo/tips/ 2>/dev/null || mkdir -p python_tips_repo/tips && cp tips/*.ipynb python_tips_repo/tips/
          cp tip_history.json python_tips_repo/ 2>/dev/null || true
          
          # Commit and push to Python_Tips repo
          cd python_tips_repo
          git add tips/*.ipynb tip_history.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No new tips to commit"
          else
            git commit -m "ğŸ Add daily Python tip [automated]"
            git push origin master
            echo "âœ… Successfully pushed new tip to Python_Tips repository!"
          fi

